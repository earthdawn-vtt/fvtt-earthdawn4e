name: Start Release from current branch

env:
    NODE_VERSION: 22

on: workflow_dispatch

jobs:
  release-tag-pr:
    runs-on: ubuntu-latest

    steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Verify valid branch
          if: ${{ github.ref_type != 'branch' || ! startsWith(github.ref_name, 'release/') }}
          run: |
            echo "Releases can only be started from a 'release/*' branch."
            exit 1

        - name: Load system manifest
          id: manifest
          uses: ActionsTools/read-json-action@main
          with:
            file_path: "./system.json"

        - name: Set up variables
          id: get_vars
          run: |
            MANIFEST_ID=${{ steps.manifest.outputs.id }}
            MANIFEST_VERSION=${{ steps.manifest.outputs.version }}
            TAG_NAME=release-$MANIFEST_VERSION
            echo "MANIFEST_ID=$MANIFEST_ID" >> $GITHUB_ENV
            echo "MANIFEST_VERSION=$MANIFEST_VERSION" >> $GITHUB_ENV
            echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

        - name: Verify version and tag name
          env:
            TAG_NAME: ${{ env.TAG_NAME }}
            MANIFEST_VERSION: ${{ env.MANIFEST_VERSION }}
          run: |
            # Validate that the release branch version matches the manifest version
            if [[ ! $GITHUB_REF_NAME == *$MANIFEST_VERSION ]]; then
              echo "The branch name does not match the system.json version."
              echo "branch name: $GITHUB_REF_NAME"
              echo "system.json: $MANIFEST_VERSION"
              echo "Please fix this and try again."
              exit 1
            }
            
            # Validate that the tag being created will match the manifest version
            if [[ ! $TAG_NAME == release-$MANIFEST_VERSION ]]; then
              echo "The system.json version does not match the expected tag name."
              echo "system.json: $MANIFEST_VERSION"
              echo "expected tag name: $TAG_NAME"
              echo "Please fix this and try again."
              exit 1
            }

        - name: Set up Git
          run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        - name: Update Changelog
          uses: stefanzweifel/changelog-updater-action@v1
          with:
            latest-version: ${{ env.MANIFEST_VERSION }}

        - name: Commit changelog update
          run: |
            git add CHANGELOG.md
            git commit -m "chore: update CHANGELOG for ${{ env.MANIFEST_VERSION }}" \
              --trailer "Github-Workflow": ${{ github.workflow }}" \ 
              --trailer "Github-Workflow-Triggered-By:${{ github.triggering_actor }}" \
              --trailer "Github-Workflow-Executed-By: ${{ github.actor }}" \
              --trailer "Github-Workflow-Run-ID: ${{ github.run_id }}" \
            || echo "No changes to commit"
            git push

        - name: Create tag
          run: |
            git tag -a ${{ env.TAG_NAME }} -m "release: ${{ env.MANIFEST_VERSION }}" \
              --trailer "Github-Workflow": ${{ github.workflow }}" \ 
              --trailer "Github-Workflow-Triggered-By:${{ github.triggering_actor }}" \
              --trailer "Github-Workflow-Executed-By: ${{ github.actor }}" \
              --trailer "Github-Workflow-Run-ID: ${{ github.run_id }}"
            git push --follow-tags

        - name: Create Pull Request
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            gh pr create \
              --title "ðŸ”– Release ${{ env.MANIFEST_VERSION }}" \
              --body "Auto-Generated
            
            This PR sets up release ${{ env.MANIFEST_VERSION }}.
            
            Github-Workflow: ${{ github.workflow }} 
            Github-Workflow-Triggered-By:${{ github.triggering_actor }}
            Github-Workflow-Executed-By: ${{ github.actor }}
            Github-Workflow-Run-ID: ${{ github.run_id }}"
              --head $GITHUB_REF_NAME \
              --base main \
              --label "release" \
              --assignee @me
