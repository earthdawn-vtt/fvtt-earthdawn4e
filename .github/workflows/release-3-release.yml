# Adapted from systems "dnd5e", "draw-steel", "artichron", https://www.thisdot.co/blog/tag-and-release-your-project-with-github-actions-workflows and more
name: Release [3] - Create Release
run-name: Create GitHub Release - Triggered by ${{ github.triggering_actor }}

env:
  NODE_VERSION: 22

on:
  pull_request:
    types:
      - auto_merge_enabled
    branches:
      - main

permissions:
  contents: write
  id-token: write
  pull-requests: read

jobs:
  branch-gate:
    name: Detect release branch
    runs-on: ubuntu-latest
    outputs:
      HEAD_REF_NAME: ${{ steps.detect_branch.outputs.HEAD_REF_NAME }}
      IS_RELEASE_BRANCH: ${{ steps.detect_branch.outputs.is_release_branch }}

    steps:
      - name: Detect PR head branch
        id: detect_branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_EVENT_MERGE_GROUP_HEAD_REF: ${{ github.event.merge_group.head_ref }}
        shell: bash
        run: |
          set -euo pipefail
          
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            HEAD_REF_NAME="$GITHUB_HEAD_REF"
          else
            # Merge queue branch name format: gh-readonly-queue/{base_branch}/pr-{pr_number}-{head_sha}
            PR_NUMBER_REGEX='/pr-([0-9]+)-'
          
            if [[ "$GITHUB_EVENT_MERGE_GROUP_HEAD_REF:-" =~ $PR_NUMBER_REGEX ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
            else
              echo "Could not extract PR number from merge queue head ref: ${GITHUB_EVENT_MERGE_GROUP_HEAD_REF:-<empty>}"
              exit 1
            fi
          
            HEAD_REF_NAME="$(gh pr view $PR_NUMBER --repo "$REPO" --json headRefName -q '.headRefName')"
          fi
          
          echo "HEAD_REF_NAME=$HEAD_REF_NAME" >> $GITHUB_OUTPUT
          echo "::notice::Computed HEAD_REF_NAME: $HEAD_REF_NAME"
          
          if [[ "$HEAD_REF_NAME" == release/* ]]; then
            IS_RELEASE_BRANCH=true
          else
            IS_RELEASE_BRANCH=false
          fi
          echo "is_release_branch=$IS_RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "::notice::Computed IS_RELEASE_BRANCH: $IS_RELEASE_BRANCH"

      - name: Log outputs
        run: |
          echo "steps.detect_branch.outputs.HEAD_REF_NAME = ${{ steps.detect_branch.outputs.HEAD_REF_NAME }}"
          echo "steps.detect_branch.outputs.is_release_branch = ${{ steps.detect_branch.outputs.is_release_branch }}"

  pr-check:
    name: pr-build-gate
    needs: branch-gate
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - run: echo "PR gate check."

  build:
    needs: branch-gate
    name: Build and Create GitHub Release
    if: ( github.event_name != 'pull_request' || github.event.action == 'enqueued' ) && needs.branch-gate.outputs.IS_RELEASE_BRANCH == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    outputs:
          TAG_NAME: ${{ steps.get_vars.outputs.TAG_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load system manifest
        id: manifest
        uses: ActionsTools/read-json-action@main
        with:
          file_path: "./system.json"


      # Set up variables for future use
      - name: Set up variables
        id: get_vars
        run: |
          TAG_NAME=${{ vars.RELEASE_TAG_PREFIX }}${{ steps.manifest.outputs.version }}
          PACKAGE_ID=${{ steps.manifest.outputs.id }}
          PACKAGE_TYPE=system
          ZIP_NAME=$PACKAGE_ID-$TAG_NAME.zip
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "PACKAGE_ID=$PACKAGE_ID" >> $GITHUB_ENV
          echo "PACKAGE_TYPE=$PACKAGE_TYPE" >> $GITHUB_ENV
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_DOWNLOAD_URL=https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_INSTALL_URL=https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/PACKAGE_TYPE.json" >> $GITHUB_ENV

      # Run some tests to make sure our `system.json` is correct
      # Exit before setting up node if not
      - name: Verify correct naming
        env:
          TAG_NAME: ${{ env.TAG_NAME }}
          RELEASE_DOWNLOAD_URL: ${{ env.RELEASE_DOWNLOAD_URL }}
          PACKAGE_TYPE: ${{ env.PACKAGE_TYPE }}
          PACKAGE_VERSION: ${{ steps.manifest.outputs.version }}
          PACKAGE_DOWNLOAD_URL: ${{ steps.manifest.outputs.download }}
        run: |
          # Validate that the tag being released matches the package version
            if [[ ! $TAG_NAME == ${{ vars.RELEASE_TAG_PREFIX }}$PACKAGE_VERSION ]]; then
              echo "The $PACKAGE_TYPE.json version does not match the tag name."
              echo "$PACKAGE_TYPE.json: $PACKAGE_VERSION"
              echo "tag name: $TAG_NAME"
              echo "Please fix this and add the PR to the merge queue again."
              exit 1
            fi
          
          # Validate that the package download URL matches the release asset that will be created.
            if [[ ! $RELEASE_DOWNLOAD_URL == $PACKAGE_DOWNLOAD_URL ]]; then
                echo "The $PACKAGE_TYPE.json download URL does not match the created release asset url."
                echo "$PACKAGE_TYPE.json: $PACKAGE_DOWNLOAD_URL"
                echo "release asset url: $RELEASE_DOWNLOAD_URL"
                echo "Please fix this and add the PR to the merge queue again."
                exit 1
            fi

      - name: Adjust manifest
        uses: TomaszKandula/variable-substitution@v1.0.2
        with:
          files: 'system.json'
        env:
          flags.hotReload: false

      - name: Set up Node.js {{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # `npm ci` is recommended:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build all
        run: npm run build

      - name: Create zip archive
        run: |
          zip --recurse-paths ./${{ env.ZIP_NAME }}  \
          system.json                   \
          package.json                  \
          earthdawn4e.mjs               \
          earthdawn4e.css               \
          assets/                       \
          fonts/                        \
          lang/                         \
          module/                       \
          packs/                        \
          templates/

      - name: Set up Git
        run: |
          git config --global user.name "${{ vars.BOT_USER_NAME_GITHUB_ACTIONS }}"
          git config --global user.email "${{ vars.BOT_EMAIL_GITHUB_ACTIONS }}"

      - name: Create Release
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > release_notes.md <<EOF
          For more notes on this release, see [here](https://github.com/${{ github.repository }}/blob/${{ env.TAG_NAME }}/CHANGELOG.md)
          
          **Installation:** To manually install this release, please use the following manifest URL: ${{ env.RELEASE_INSTALL_URL }}
          EOF
          
          gh release create ${{ env.TAG_NAME }} ./${{ env.ZIP_NAME }} ./system.json \
            --draft=false \
            --fail-on-no-commits \
            --generate-notes \
            --notes-file release_notes.md \
            --prerelease=false \
            --title "${{ steps.manifest.outputs.version }}" \
            --verify-tag=true

  push-to-foundry:
    needs: build
    if: needs.build.result == 'success'
    uses: ./.github/workflows/release-4-foundry-package.yml
    with:
      release-tag: ${{ needs.build.outputs.TAG_NAME }}
