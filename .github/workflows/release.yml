# Adapted from systems "dnd5e", "draw-steel", "artichron", https://www.thisdot.co/blog/tag-and-release-your-project-with-github-actions-workflows and more
name: Release Creation

env:
  NODE_VERSION: 22

on:
  pull_request:
    branches:
      - 'main'
  merge_group:
    types: [checks_requested]

jobs:
  build:
    if: startsWith(github.head_ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load system manifest
        id: manifest
        uses: ActionsTools/read-json-action@main
        with:
          file_path: "./system.json"


      # Set up variables for future use
      - name: Set up variables
        id: get_vars
        run: |
          TAG_NAME=release-${{ steps.manifest.outputs.version }}
          PACKAGE_ID=${{ steps.manifest.outputs.id }}
          PACKAGE_TYPE=system
          ZIP_NAME=$PACKAGE_ID-$TAG_NAME.zip
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "PACKAGE_ID=$PACKAGE_ID" >> $GITHUB_ENV
          echo "PACKAGE_TYPE=$PACKAGE_TYPE" >> $GITHUB_ENV
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_INSTALL_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/PACKAGE_TYPE.json" >> $GITHUB_ENV

      # Run some tests to make sure our `system.json` is correct
      # Exit before setting up node if not
      - name: Verify correct naming
        env:
          TAG_NAME: ${{ env.TAG_NAME }}
          RELEASE_DOWNLOAD_URL: ${{ env.RELEASE_DOWNLOAD_URL }}
          PACKAGE_TYPE: ${{ env.PACKAGE_TYPE }}
          PACKAGE_VERSION: ${{ steps.manifest.outputs.version }}
          PACKAGE_DOWNLOAD_URL: ${{ steps.manifest.outputs.download }}
        run: |
          # Validate that the tag being released matches the package version
            if [[ ! $TAG_NAME == release-$PACKAGE_VERSION ]]; then
              echo "The $PACKAGE_TYPE.json version does not match the tag name."
              echo "$PACKAGE_TYPE.json: $PACKAGE_VERSION"
              echo "tag name: $TAG_NAME"
              echo "Please fix this and push the tag again."
              exit 1
            fi
          
          # Validate that the package download URL matches the release asset that will be created.
            if [[ ! $RELEASE_DOWNLOAD_URL == $PACKAGE_DOWNLOAD_URL ]]; then
                echo "The $PACKAGE_TYPE.json download URL does not match the created release asset url."
                echo "$PACKAGE_TYPE.json: $PACKAGE_DOWNLOAD_URL"
                echo "release asset url: $RELEASE_DOWNLOAD_URL"
                echo "Please fix this and push the tag again."
                exit 1
            fi

      - name: Adjust manifest
        uses: TomaszKandula/variable-substitution@v1.0.2
        with:
          files: 'system.json'
        env:
          flags.hotReload: false

      - name: Set up Node.js {{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # `npm ci` is recommended:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build all
        run: npm run build

      - name: Create zip archive
        run: |
          zip --recurse-paths ./${{ env.ZIP_NAME }}  \
          system.json                   \
          package.json                  \
          earthdawn4e.mjs               \
          earthdawn4e.css               \
          assets/                       \
          fonts/                        \
          lang/                         \
          module/                       \
          packs/                        \
          templates/

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create Release
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.TAG_NAME }} ./${{ env.ZIP_NAME }} ./system.json \
            --draft=false \
            --fail-on-no-commits \
            --generate-notes \
            --notes "For more release notes have a look in ./CHANGELOG.md\n\n**Installation:** To manually install this release, please use the following manifest URL: ${{ env.RELEASE_INSTALL_URL }}" \
            --prerelease=false \
            --title "${{ steps.manifest.outputs.version }}" \
            --verify-tag=true
